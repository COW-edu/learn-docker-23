# 8장 헬스 체크와 디펜던시 체크로 애플리케이션의 신뢰성 확보하기

플랫폼이 제공하는 기능을 활용하기 위해 필요한 정보를 컨테이너 이미지에 추가하는 방법을 알아보자.

## 헬스 체크를 지원하는 도커 이미지 빌드하기

도커는 컨테이너를 시작할 때마다, 애플리케이션의 기본적인 상태를 확인한다.
정확히는 컨테이너 실행 시 함께 시작되는 특정한 프로세스를 체크하여, 프로세스가 종료 상태가 되면 컨테이너도 종료 상태가 된다.

단순히 실행 여부 체크를 넘어 애플리케이션의 상태를 체킹하기 위해, Dockerfile 스크립트에 상태 확인을 위한 로직을 추가 설정하면 된다.

```dockerfile
# -f 옵션을 이용하여 Dockerfile 스크립트 파일의 경로를 지정할 수 있다.
docker image build -t diamol/ch08-numbers-api:v2 -f ./numbersapi/Dockerfile.v2
```

이미지에 헬스 체크 기능이 추가된다면, 컨테이너 실행 시 이상 상태 여부(healthy/unhealthy)가 함께 출력된다.

컨테이너의 이상 상태는 도커 API를 통해 보고된다. 따라서 컨테이너를 실행 중인 플랫폼도 컨테이너 이상 상태를 통보받고 애플리케이션을 복구하기 위한 조치를 취할 수 있다.

`docker container inspect` 명령에서 `State` 필드는 컨테이너의 상태에 대한 자세한 정보를 담고 있다.
* 컨테이너를 비정상 상태로 간주하는 헬스 체크 실패 횟수는 기본값이 세번이다.
* 도커가 컨테이너의 이상 상태를 감지하여도, 후속 조치를 하지 않는다는 점도 특징이다.
  * 컨테이너를 중지, 재시작하는 동안 애플리케이션이 동작하지 않는다.
  * 컨테이너를 교체하면, 보관된 데이터도 함께 유실된다.

클러스터 환경에서는 컨테이너를 추가로 실행할 여력이 항상 있으므로, 이상 상태를 보이는 컨테이너를 그대로 두고 대체 컨테이너를 실행하여
애플리케이션의 중단 없이 상태를 회복할 수 있다.

## 디펜던시 체크가 적용된 컨테이너 실행하기
분산 환경에서 이상이 생긴 컨테이너를 교체할 때는, 컨테이너 간 의존 관계를 고려하지 않기에 문제가 될 수 있다.

이를 체크하기 위해서는, 도커 이미지에 디펜던시 체크 기능을 추가하면 된다.
디펜던시 체크란, 애플리케이션 실행 전에 필요한 요구사항을 확인하는 기능으로, 애플리케이션 실행 시점 이전에 실행된다.

실행 명령에 디펜던시 체크를 추가한 Dockerfile 스크립트
```dockerfile

FROM diamol/dotnet-aspnet

ENV RngApi:Url=http://numbers-api/rng

CMD curl --fail http://numbers-api/rng && \
    dotnet Numbers.Web.dll
    
WORKDIR /app
COPY --from=builder /out/ .
```

`CMD` 인스트럭션에 정의된 명령은 컨테이너를 실행할 때 실행된다. API에 HTTP 요청을 보내 해당 API가 사용 가능한지 확인한다.

## 애플리케이션 체크를 위한 커스텀 유틸리티 만들기
* curl이 상태 체크를 위해 유용하지만, 보안 정책상의 이유로 이미지에 curl을 포함시킬 수는 없다.
* 따라서 실제 애플리케이션 체크에는 애플리케이션과 같은 언어로 구현된 별도의 커스텀 유틸리티를 사용하는 것이 낫다.

* 커스텀 유틸리티를 실행할 때 애플리케이션과 같은 툴을 사용하므로, 이미지에 추가적인 소프트웨어를 포함시킬 필요가 없다.
* 재시도 횟수나 분기 등 셸 스크립트로는 표현하기 까다로운 복잡한 체크 로직을 적용할 수 있다.
* 애플리케이션과 같은 설정을 사용해 대상 URL을 여러 곳에 반복 정의하거나 수정에서 누락시키는 일을 방지할 수 있다.
* DB 접속이나 인증서 파일의 존재 유무 등 컨테이너 실행 전에 확인이 필요한 모든 사항을 검증할 수 있다.
* 또한 컨테이너 플랫폼에 상관 없이 모든 환경에서도 동작하게 되므로, 이미지의 이식성을 향상시킬 수 있다.

## 도커 컴포즈에 헬스 체크와 디펜던시 체크 정의하기

헬스 체크
```dockerfile
numbers-web:
    image: diamol/ch08-numbers-web:v3
    restart: on-failure # 컨테이너가 예기치 않게 종료되면 컨테이너를 재시작한다.
    ports:
        - "8088:80"
    healthcheck:
        test: ["CMD", "dotnet", "Utilities.HttpCheck.dll", "-t", "150"]
        interval: 5s # 헬스체크 실시 간격
        timeout: 1s # 응답 제한 시간
        retries: 2 # 컨테이너 상태 이상 간주시까지 필요한 헬스 체크 연속 실패 횟수
        start_period: 10s # 컨테이너 실행 후 헬스 체크를 실시하는 시간 간격. 애플리케이션 로딩 시간이 오래 걸리는 경우 유용하다.
    
    networks:
        - app-net
```
## 헬스 체크와 디펜던시 체크로 복원력 있는 애플리케이션을 만들 수 있는 이유
디펜던시 체크와 헬스 체크를 도입하면 처음부터 플랫폼이 실행 순서를 보장하게 할 필요가 없다.
일부 컨테이너가 의존 관계를 만족하지 못한 상태라면 재실행되거나 다른 컨테이너로 교체될 것이다.

하지만, 헬스 체크는 주기적으로 자주 실행되므로 시스템에 부하를 주면 안 된다.
* 자원을 너무 많이 소모하지 않으면서 애플리케이션이 실질적으로 동작 중인지 검증할 수 있는 핵심적인 부분을 테스트해야 한다.
디펜던시 체크는 애플리케이션 시작 시에만 실행되므로, 테스트에 소모되는 리소스에 너무 크게 신경 쓸 필요가 없다.
* 테스트 대상이 빠짐없이 정확하도록 주의하자.
