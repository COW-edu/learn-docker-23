# 애플리케이션의 신뢰성

`#docker`

### 목차

- [헬스 체크](#✏️-헬스-체크)
  - [도커가 프로세스 실행상태 체크를 체크해준다고?](#🔎-도커가-프로세스-실행상태-체크를-체크해준다고)
  - [실행상태는 애플리케이션의 상태가 아니잖아](#🔎-실행상태는-애플리케이션의-상태가-아니잖아)
- [이상 상태의 애플리케이션](#✏️-이상-상태의-애플리케이션)
  - [이상상태의 컨테이너가 실행중이라고?](#🔎-이상상태의-컨테이너가-실행중이라고)
  - [이상상태의 컨테이너의 무중단회복](#🔎-이상상태의-컨테이너의-무중단회복)
- [디펜던시 체크](#✏️-디펜던시-체크)
  - [디펜던시 체크가 없다면 발생할 수 있는 문제](#🔎-디펜던시-체크가-없다면-발생할-수-있는-문제)
  - [디펜던시 체크 기능](#🔎-디펜던시-체크-기능)
- [참고 문헌](#📖-참고-문헌)

<div style="height:100px"></div>

## ✏️ 헬스 체크

### 🔎 도커가 프로세스 실행상태 체크를 체크해준다고?

- 도커는 컨테이너를 시작할 때마다 애플리케이션의 기본적인 상태를 확인함
  - 애플리케이션이 실행되면 특정 프로세스가 실행되는데, 이 상태가 만약 종료되었다면 컨테이너도 종료 상태가 됨
    - 환경과 무관한 기본적인 헬스 체크 가능
    - 클러스터 환경에서는 플랫폼이 종료된 컨테이너를 재시작하거나 새 컨테이너로 교체 작업을 진행

### 🔎 실행상태는 애플리케이션의 상태가 아니잖아

- 프로세스의 실행상태는 애플리케이션의 상태가 실제로 정상임을 보장하지 않음
- 도커는 애플리케이션의 상태를 확인할 수 있는 정보를 도커 이미지에 직접 넣는 기능 제공함

#### 방식

- Dokerfile 스크립트에 상태 확인을 위한 `HEALTHCHECK` 인스트럭션 추가
- 컨테이너 런타임은 인스트럭션에 정의된 정보를 이용해 컨테이너에서 동작 중인 애플리케이션의 상태가 정상인지 확인 가능
  - HEALTHCHECK 인스트럭션에는 도커가 컨테이너 안에서 실행하는 명령을 지정
  - 명령이 반환하는 상태 코드를 보고 애플리케이션의 상태를 판단
- 도커는 일정한 시간 간격으로 컨테이너 안에서 지정된 명령을 실행
  - 상태코드가 정상 -> 컨테이너도 정상
  - 상태고드가 연속으로 일정 횟수 이상 실패 -> 컨테이너를 이상 상태로 간주
  <div style="height:100px"></div>

## ✏️ 이상 상태의 애플리케이션

### 🔎 이상상태의 컨테이너가 실행중이라고?

- 애플리케이션이 이상 상태임에도 컨테이너는 실행중인 모습을 보일 수 있음
- 이상 상태에 있는 컨테이너를 재시작하거나 다른 컨테이너로 교체하지않았음을 의미
- 도커 엔진은 단일 서버에서 동작하기 때문임

#### 도커는 이상상태인 컨테이너를 건들지 않은 이유

- 도커가 해당 작업을 **안전하게** 처리할 수 없기 때문임
  - 이상이 생긴 컨테이너를 도커가 중지 및 재시작 할 수는 있지만, 그 시간동안 애플리케이션이 동작하지않음
- 이상상태를 통보만하고 컨테이너는 그대로 두는 것
- 헬스 체크도 계속적으로 수행되기에 일시적인 헬스체크 실패뿐이었다면 컨테이너의 상태는 다시 정상으로 돌아감

### 🔎 이상상태의 컨테이너의 무중단회복

- 클러스터 환경에서는 애플리케이션의 중단 시간 없이 상태 회복이 가능

  > 클러스터 환경 <br/>
  > : 도커가 동작하는 여러 대의 서버로 구성되고 도커 스웜이나 쿠버네티스가 관리하는 환경

- 헬스 체크를 통해 컨테이너 플랫폼이 컨테이너의 이상 상태를 통보받으면, 클러스터는 이상 상태를 보이는 컨테이너를 그대로 두고 대체 컨테이너를 실행하므로 무중단으로 상태 회복이 가능해짐
<div style="height:100px"></div>

## ✏️ 디펜던시 체크

### 🔎 디펜던시 체크가 없다면 발생할 수 있는 문제

클러스터를 통해 헬스 체크로 확인한 비정상 상태의 컨테이너를 새 컨테이너를 실행해 무중단으로 복구할 수 있지만, 이상이 생긴 컨테이너 교체시에는 처음 애플레케이션을 실행할 때처럼 컨테이너 간 의존 관계(dependency)를 고려하지않음

- 의존관계를 만족하는지 점검하는 디펜던시 체크 기능을 도커 이미지에 추가해야함

### 🔎 디펜던시 체크 기능

- 애플리케이션 실행 전에 필요한 요구 사항 확인
- 모든 요구 사항을 확인하면, 디펜던시 체크가 성공하고 애플리케이션이 실행
- 만족하지 못하는 요구사항이 존재하는 경우, 디펜던시 체크가 실패해 애플리케이션이 실행불가
- 애플리케이션 실행 명령에 로직을 추가하여 구현

<div style="height:150px"></div>

### 📖 참고 문헌

도커 교과서 제 2부 컨테이너로 분산 애플리케이션 실행하기 Ch08
