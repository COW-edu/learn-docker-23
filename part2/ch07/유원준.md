# 7장 도커 컴포즈로 분산 애플리케이션 실행하기

도커는 분산된 컴포넌트를 실행하는 데에 이상적인 환경이다.
각 컴포넌트는 각자의 경량 컨테이너에서 실행되며, 도커 컴포즈를 이용하면 여러 컨테이너에 걸쳐 실행되는 애플리케이션을 정의하고 관리할 수 있다.

## 도커 컴포즈 파일의 구조
* 도커 컴포즈 파일이란? 모든 컴포넌트가 실행 중일 때 어떤 상태여야 하는지를 기술하는 파일이다. 
* `docker container run` 으로 컨테이너가 실행될 때 지정할 옵션을 모아 둔 파일이다.
* 도커 컴포즈 파일을 작성하면, 도커 컴포즈 도구를 이용해 애플리케이션이 실행되고, 도커 컴포즈가 컨테이너, 네트워크, 볼륨 등 필요한 도커 객체를 만들도록 
도커 API에 명령을 내린다.
* 도커 컴포즈 파일은 yaml 문법으로 기술된다.

```text
version : 도커 컴포즈 파일 형식의 버전
services : 모든 컴포넌트를 열거하는 부분 - 서비스 단위로 기술(하나의 서비스를 같은 이미지로 여러 컨테이너에서 실행 가능하기 때문)
networks : 서비스 컨테이너가 연결될 모든 도커 네트워크를 열거
```

* 도커를 설치하면 자동으로 생성되는 기본 네트워크는 `nat` 이다.
* 도커 컴포즈 파일을 통해 애플리케이션의 모든 실행 옵션이 기술되므로, README파일에 애플리케이션 이미지 이름이나 공개해야 할 포트번호를 문서화할 필요가 없다.
* 도커 컴포즈를 이용하려면 `docker-compose` 명령을 이용하고, 애플리케이션을 실행하려면 `up` 명령을 실행하면 된다.

## 도커 컴포즈를 사용해 여러 컨테이너로 구성된 애플리케이션 실행하기

* `docker-compose`
  * `up -d --scale 컨테이너명=컨테이너수` : docker-compose를 이용한 스케일 아웃 명령
    * API 서비스 등 상태가 없는 경우, 컨테이너를 늘리는 방식으로 스케일 아웃이 가능함.
    * 웹 컨테이너가 API에 데이터 요청시, 도커가 여러 개의 API 컨테이너에 요청을 분배해주는 역할.

  * `down` : 애플리케이션을 중지하고 컨테이너를 모두 제거하며 결과적으로 애플리케이션을 제거한다.
    * external 플래그가 없다면, 네트워크와 볼륨도 함께 제거한다.

## 도커 컨테이너 간의 통신
도커 컨테이너는 도커 엔진으로부터 부여받은 가상 IP 주소를 갖고 같은 도커 네트워크로 연결되어 통신하는 구조이다.
하지만 애플리케이션 생애주기에서 도커 컨테이너가 교체되면, 해당 IP 주소도 변경된다. 이를 위해 도커에서 DNS를 이용해 서비스 디스커버리 기능을 제공한다.

* 컨테이너 이름을 조회 시, 컨테이너의 IP 주소를 찾아 준다.
* 도메인이 가리키는 대상이 컨테이너가 아니면 도커 엔진을 실행 중인 컴퓨터가 속한 네트워크나 IP 주소를 조회한다.

만약 도커 컴포즈에서 관리하던 컨테이너를 강제로 삭제하면, 애플리케이션의 상태가 컴포즈 파일에 정의된 것과 달라진다.
도커 컴포즈는 이를 위해 새로운 컨테이너를 만들어서 이에 대응한다.

또한, 하나의 도메인에 대한 DNS 조회 결과에서 여러 개의 IP 주소를 가질 수 있다.
도커 컴포즈는 이를 이용하여 모든 컨테이너에 조회 결과의 순서를 매번 변화시켜 로드밸런싱을 구현할 수 있다.

## 도커 컴포즈로 애플리케이션 설정값 지정하기

`environment`에는 컨테이너 안에서 사용될 환경 변수 값이 정의된다.
`secrets`에는 실행 시 컨테이너 내부에 파일에 기록될 비밀값이 정의된다.
* 비밀값은 주로 클러스터 환경에서 쿠버네티스나 도커 스웜같은 컨테이너 플랫폼을 통해 제공되며, 평시에는 클러스터 DB에 암호화되어 저장되어 있다.

## 도커 컴포즈도 만능은 아니다.
도커 컴포즈는 복잡한 분산 애플레케이션의 설정을 짧고 명료한 포맷의 파일로 나타낼 수 있다는 장점이 있음.

하지만, 도커 컴포즈는 완전한 컨테이너 플랫폼이 아니므로 일부 컨테이너에서 오류 발생 혹은 강제 종료가 된다면, `docker-compose up` 명령 없이는 
애플리케이션의 상태 복구가 불가능하다.

따라서 운영 환경보다는 CI나 단일 서버 내 테스트 환경 구축시 사용하기 용이하다.
