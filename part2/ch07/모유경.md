# 도커 컴포즈 파일

`#docker`

### 목차

- [도커 컴포즈 파일의 구조](#✏️-도커-컴포즈-파일의-구조)
  - [컨테이너들은 누가 실행해?](#🔎-컨테이너들은-누가-실행해)
  - [도커 컴포즈 파일이 뭔데?](#🔎-도커-컴포즈-파일이-뭔데)
- [도커 컴포즈로 애플리케이션을 배포하는 경우 주의점](#✏️-도커-컴포즈로-애플리케이션을-배포하는-경우-주의점)
- [도커 컨테이너 간의 통신](#✏️-도커-컨테이너-간의-통신)
- [참고 문헌](#📖-참고-문헌)

<div style="height:100px"></div>

## ✏️ 도커 컴포즈 파일의 구조

Dockerfile 스크립트는 애플리케이션을 패키징하기 위한 스크립트이지만, 분산 애플리케이션을 기준으로 보면 Dockerfile 스크립트는 애플리케이션의 한 부분을 패키징하는 수단에 지나지않음

- 웹 프런트엔드, 백엔드API, 데이터베이스를 갖춘 애플리케이션의 경우 이를 패키징하기 위해서 각 컴포넌트 하나씩 세 개의 Dockerfile 스크립트가 필요하게 되는 것

### 🔎 컨테이너들은 누가 실행해?

- 직접 순서대로 각각의 컨테이너를 도커 명령행을 통해 일일이 옵션을 지정해 가며 실행
  - 실수와 오류의 원천에 노출이 쉬운 수동 프로세스에 해당
- **도커 컴포즈 파일에 애플리케이션 구조를 정의** (권장)

### 🔎 도커 컴포즈 파일이 뭔데?

- 설령 애플리케이션이 단일 서비스라고 할지라도 컴포즈 파일을 통해 설정사항에 대한 간접적 문서화 효과를 누릴 수 있음
- 모든 컴포넌트가 실행 중일 때 어떤 상태여야 하는지를 기술하는 파일
- `docker container run` 명령으로 컨테이너를 실행할 때 지정하는 모든 옵션을 모아 놓은 단순한 형식의 파일
- YAML 문법으로 기술
  - 들여쓰기를 통해 구조를 정의하므로 들여쓰기가 중요

#### 실행과정

1. 도커 컴포즈 파일을 작성
2. 도커 컴포즈 도구를 사용해 애플리케이션을 실행 `docker-compose up`
3. 도커 컴포즈가 컨테이너, 네트웤, 볼륨 등 필요한 모든 도커 객체를 만들도록 도커 API에 명령을 내림

<img width="603" alt="컴포즈 파일 아키텍쳐" src="https://github.com/COW-edu/COW-23-Basic/assets/75975946/8e715b33-853c-447f-9827-a07adfab5c51">

#### 구성

```
version: '3.7'

services:

  todo-web:
    image: diamol/ch06-todo-list
    ports:
      - "8020:80"
    networks:
      - app-net

networks:
  app-net:
    external:
      name: nat
```

3개의 최상위 문(statement)으로 구성

- version
  - 파일에 사용된 도커 컴포즈 파일 형식의 버전
- services

  - 애플리케이션을 구성하는 모든 컴포넌트를 열거하는 부분
  - 하나의 서비스를 같은 이미지로 여러 컨테이너에서 실행할 수 있으므로 도커 컴포즈에서는 실제 컨테이너 대신 **서비스 개념**을 단위로 삼음
  - 서비스 이름은 컨테이너의 이름이자 도커 네트워크상에서 다른 컨테이너들이 해당 컨테이너를 식별하기 위한 DNS이름으로도 사용 됨
  - 서비스의 이름 아래로는 속성이 기술

    - 기술되는 내용은 docker container run 명령의 옵션과 그 지정값의 쌍 형태임

      - image : 실행할 이미지를 지정하는 필드
      - ports : 공개할 포트에 대한 정보
      - networks : 컨테이너가 접속할 도커 네트워크를 정의하는 필드

- networks
  - 서비스 컨테이너가 연결될 모든 도커 네트워크를 열거
  - external 필드의 의미는 nat 네트워크가 이미 존재하므로 새로 생성하지말라는 의미

<div style="height:100px"></div>

## ✏️ 도커 컴포즈로 애플리케이션을 배포하는 경우 주의점

#### 문제

- 도커 컴포즈는 클라이언트 측에서 동작하는 도구에 해당함.
- 도커 엔진은 컨테이너를 실행할 뿐이지 여러 컨테이너가 하나의 애플리케이션으로 동작하는지 여부를 파악 불가

#### 해결 방안

- YAML로 적힌 컴포즈 파일을 읽어 애플리케이션의 구조를 이해한 컴포즈의 사용이 요구

> 도커 컴포즈로 애플리케이션을 배포하는 경우에도 애플리케이션을 구성하는 다양한 리소스가 생성되지만, 도커 엔진의 입장에서 이들이 어떤 관계를 갖는지는 알 수 없으므로 컴포즈 파일을 통해 리소스를 관리해야함

<div style="height:100px"></div>

## ✏️ 도커 컨테이너 간의 통신

- 컨테이너는 별도의 네트워크 공간을 가진 가상 환경
- 컨테이너는 도커 엔진으로부터 부여받은 자신만의 가상 IP주소를 갖으며 모두 같은 도커 네트워크로 연결돼 IP주소를 통해 서로 통신가능
  - 도커가 서비스 디스커버리 기능 제공
    > 서비스 디스커버리 기능 <br/>
    > : 애플리케이션 생애주기 동안 컨테이너가 교체되면 IP주소도 변경되는데, DNS를 이용해 문제가 발생하지않도록 도커에서 제공하는 기능
- 도커 네트워크에 연결된 모든 컨테이너는 네트워크의 범위에 포함되는 IP주소를 부여받고, 네트워크를 통해 컨테이너간 통신이 가능
- 도커에도 DNS서비스가 내장
  - 컨테이너에서 실행 중인 애플리케이션도 다른 구성 요소에 접근하기 위해 DNS서비스를 사용
    > DNS는 IP주소를 도메인과 연결하는 기능을 제공하는 시스템.
    >
    > - 인터넷과 사설 네트워크에서 모두 동작 가능
    > - 컨테이너 이름을 도메인 삼아 조회하면 해당 컨테이너의 IP주소를 제공
    > - 도커 네트워크 상에 있는 다른 컨테이너의 정보 사용 가능
    > - 만약 도메인이 가리키는 대상이 컨테이너가 아닌 경우에도, 도커 엔진을 실행중인 컴퓨터에 요청을 보내 호스트 컴퓨터가 속한 네트워크나 인터넷의 IP주소를 조회

<div style="height:150px"></div>

### 📖 참고 문헌

도커 교과서 제 2부 컨테이너로 분산 애플리케이션 실행하기 Ch07
