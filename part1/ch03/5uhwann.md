# 3장 도커 이미지 만들기

## 도커 이미지
- `docker image pull {이미지 명}`: 도커 컨테이너 이미지 내려받기
- 도커 이미지는 도커 허브의 레지스트리에 저장되어 있다.
- 도커 이미지는 물리적으로 여러 개의 작은 파일로 구성되어 있으며 이 각각의 파일들을 이미지 레이어라 부른다.

## **도커 환경변수**
- `docker container run --env {환경변수 명}:{값} {컨테이너 명}`: 컨테이너 환경변수 지정 실행
- 도커 이미지는 설정값의 기본값이 자동으로 포함되어 패키징 되지만 이 설정값을 바꿀 수 있어야 한다.
- 컨테이너는 도커가 부여한 환경 변수만을 갖는다.

## Dockerfile
- 애플리케이션을 패키징하기 위한 스크립트, 일련의 인스트럭션으로 구성되어 있음.(깃헙 workflow의 job과 유사)
- **인스트럭션**
  - **FROM**: 이미지의 시작점 지정(런타입이 설치된 시작 이미지)
  - **ENV**: 환경 변수 값을 지정, [key] = [value] 형식  -> 이식성 있는 이미지 생성 가능
  - **WORKDIR**: 컨테이너 이미지 파일 시스템에 디렉터리 생성 및 해당 디렉터리를 작업 디렉터리로 지정
  - **COPY**: 로컬 파일 시스템의 파일, 디렉토리를 컨테이너 이미지로 복사, [원본경로] [복사경로]
  - **CMD**: 도커가 이미지로부터 컨테이너 실행 시 실행할 명령 지정

## 컨테이너 이미지 빌드
- 이미지 빌드를 위해서는 이미지 이름, 패키징에 필요한 파일 경로가 추가로 필요
- `docker image build --tag {이미지 이름} {이미지 포함 파일 경로}`: 컨테이너 이미지 빌드

## 도커 이미지와 이미지 레이어
- 도커 이미지 패키징에 포함된 파일들은 컨테이너의 파일 시스템을 형성
- 도커 이미지에는 메타데이터 정보 포함
- `docker image history {이미지 명}`: 한 줄마다 이미지 레이어에 대한 정보 출력
- Dockerfile의 인스트럭션과 이미지 레이어은 1:1 관계
- 도커 이미지 레이어는 도커 엔진의 캐시에 물리적으로 저장된 파일이고, 도커 이미지는 이미지 레이어가 모인 논리적 대상
  - **이미지 레이어는 여러 이미지와 컨테이너에서 공유됨**
  - 도커 이미지 레이어는 여러 이미지에서 공유되어야 하기 때문에 **읽기 전용**이다.

### **Dockerfile 스크립트 최적화 - 이미지 레이어 캐시 활용**
- Dockerfile의 인스트럭션은 각각 하나의 dㅣ미지 레이어와 1:1로 연결되지만 인스트력션 결과과 이전 빌드와 같다면, 캐시된 레이어를 재사용
  - 캐시에 일치하는 레이어를 확인하기 위해 해시값 사용
- 한번 인스트럭션이 실행되면 이후의 인스터력션도 모두 실행(캐시가 있더라도)
  - **Dockerfile의 인스트럭션은 잘 수정하지 않는 인스트럭션이 앞으로 오도록 배치**
