# 도커 이미지를 만들어보자

`#docker` `#image`

### 목차

- [이미지](#✏️-이미지)
- [이미지 빌드](#✏️-이미지-빌드)
  - [Dockerfile](#🔎-Dockerfile)
- [이미지 최적화](#✏️-이미지-최적화)
- [참고 문헌](#📖-참고-문헌)

<div style="height:100px"></div>

## ✏️ 이미지

**이미지**

- 논리적으로 하나의 대상이나 물리적으로 여러개의 작은 파일(이미지 레이어)로 구성
- 자신의 여러 메타데이터 정보를 포함
- 이미지를 찾기 위해서 도커는 가장먼저 도커 허브에 접근
  > 도커 허브 <br/>
  > : 무료로 제공되는 공개 레지스트리 <br/>
  > 레지스트리 <br/>
  > : 이미지를 제공하는 저장소
- 같은 이미지를 사용해도, 설정 값에 의해 동작을 달리 할 수 있다.
  - 환경 변수를 통해 구현가능하며, 호스트 컴퓨터에도 고유의 환경 변수가 존재하는데 이는 컨테이너와는 별개이다.
- 이미지는 내가 작성한 애플리케이션 코드 외에 Node.js런타임을 포함할 수 있다

**이미지 레이어**

- 도커 엔진의 캐시에 물리적으로 저장된 파일
- 도커가 이미지 레이어를 조립해 컨테이너의 내부 파일 시스템을 형성
- 이미지 레이어는 여러 이미지와 컨테이너에서 공유됨

  <div style="height:100px"></div>

## ✏️ 이미지 빌드

이미지 빌드를 위해서는 Dockerfile 스크립트, 이미지의 이름, 패키징에 필요한 파일의 경로를 지정해주어야한다.

` docker image build --tag 이미지이름 파일의경로`

### 🔎 Dockerfile

Dockerfile은 애플리케이션을 패키징하기위한 스크립트로 일련의 인스트럭션으로 구성됨

```docker
FROM diamol/node

ENV TARGET="blog.sixeyed.com"
ENV METHOD="HEAD"
ENV INTERVAL="3000"

WORKDIR /web-ping
COPY app.js .

CMD ["node", "/web-ping/app.js"]
```

**인스트럭션**

- 인스트럭션은 소문자를 사용해도 무방함
- FROM: 모든 이미지는 다른 이미로부터 출발하는데, 그 시작점을 지정
- ENV: 환경 변수는 [key]="[value]"형식으로 따르며, 그 값을 지정
- WORKDIR: 컨테이너 이미지 파일 시스템에 디렉터리를 만들고, 이를 작업 디렉터리로 지정하는 인스트럭션
- COPY: 로컬 파일 시스템의 파일 혹은 디렉터리를 컨테이너 이미지로 복사하는 인스트럭션
- CMD: 이미지로부터 컨테이너를 실행했을 때, 실행할 명령을 지정하는 인스트럭션

<div style="height:100px"></div>

## ✏️ 이미지 최적화

- Dockerfile 스크립트의 인스트럭션은 각각 하나의 이미지 레이어와 1:1 연결

- 인스트럭션의 결과가 이전 빌드와 동일한 경우 캐시된 레리어를 재사용 -> 인스트럭션 재실행 낭비를 막음
- 캐시에 일치하는 레이어가 있는지 확인을 위해서 해시값을 이용

  - 해시값은 Docherfiile 스크립트의 인스트럭션과 인스트럭션에 의해 복사되는 파일의 내용으로 부터 계산을 통해 이미지 레이어에 해시값이 있으면 이를 재사용하며 없다면 캐시미스가 발생해 인스트럭션이 실행

- 도서는 이미지 레이어가 특정 순서로만 배치된다고 가정하기때문에 중간에 레이어가 변경되면, 이 위에 배치되어진 레이어를 재사용할 수가 없음
  - 이미지 레이어의 재사용을 위해서는 잘 수정하지 않는 인스트럭션이 앞으로 오고, 자주 수정되는 인스트럭션이 뒤에 오도록 배치 되어야함을 의미

<div style="height:150px"></div>

### 📖 참고 문헌

도커 교과서 제 1부 도커 컨테이너와 이미지 이해하기 Ch03
