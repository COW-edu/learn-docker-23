# 도커 볼륨과 마운트

`#docker` `#share`

### 목차

- [컨테이너의 상태](#✏️-컨테이너의-상태)
  - [무상태 애플리케이션에게 최적의 실행환경이다](#🔎-무상태-애플리케이션에게-최적의-실행환경이다)
  - [애플리케이션에 상태가 없을 수는 없다](#🔎-애플리케이션에-상태가-없을-수는-없다)
  - [읽기 전용 레이어를 어떻게 수정해?](#🔎-읽기-전용-레이어를-어떻게-수정해)
- [도커 볼륨, 마운트](#✏️-도커-볼륨-마운트)
  - [데이터를 잃으면 어떻게해?](#🔎-데이터를-잃으면-어떻게해)
  - [도커 볼륨이 뭐야?](#🔎-도커-볼륨이-뭐야)
  - [도커 볼륨을 어떻게 사용해?](#🔎-도커-볼륨을-어떻게-사용해)
  - [마운트가 뭐야?](#🔎-마운트가-뭐야)
  - [마운트의 한계점](#🔎-마운트의-한계점)
- [컨테이너의 파일 시스템이 만들어지는 과정](#✏️-컨테이너의-파일-시스템이-만들어지는-과정)
  - [유니언 파일 시스템](#🔎-유니언-파일-시스템)
  - [컨테이너 스토리지 구성 일반론](#🔎-컨테이너-스토리지-구성-일반론)
- [참고 문헌](#📖-참고-문헌)

<div style="height:100px"></div>

## ✏️ 컨테이너의 상태

### 🔎 무상태 애플리케이션에게 최적의 실행환경이다

- 사용량이 증가하더라도 클러스터에 실행중인 컨테이너의 수를 늘리기만하면, 모든 요청이 똑같이 신뢰성있게 처리된다.
- 롤링 업데이트를 통해 서비스 중단 없이 점진적으로 업데이트를 배포할 수 있다.
  > 롤링 업데이트(무중단 배포)
  > : 서비스가 중단되지 않도록 배포하는 기술
  >
  > - 서비스하는 웹 애플리케이션을 내리지 않고 새로운 웹 애플리케이션을 올린다.
  > - 서버가 정상적으로 작동하면 트래픽을 새로운 버전의 애플리케이션으로 전송하므로 서비스 중단을 막는다.
  >   <br/>

### 🔎 애플리케이션에 상태가 없을 수는 없다

- 퍼시스턴시나 성능향상을 위해 디스크를 사용하는 컴포넌트가 있어야하고, 이 컴포넌트도 컨테이너에서 실행된다.

- 도커 컨테이너에도 단일 드라이브로 된 파일 시스템이 있다.
  - Dockerfile 스크립트에서 COPY 인스트럭션을 사용해 파일을 이미지로 복사하면, 이미지로 실행한 컨테이너에도 같은 경로에 복사된 파일이 존재
  - 컨테이너의 디스크도 여러개의 레이어 형태로 저장된 도커 이미지와 같이 이미지 레이어를 순서대로 합쳐만든 가상 파일 시스템에 해당
  - 모든 컨테이너는 처음에 디스크의 내용이 모두 동일하지만, 한 컨테이너에서 애플리케이션이 파일을 수정해도 다른 컨테이너나 이미지는 영향을 받지 않는다.(독립성)
  - 모든 컨테이너가 공유하는 이미지 레이어는 읽기 전용이고, 각 컨테이너가 따로 갖는 기록 가능 레이어는 컨테이너와 같은 생애주기를 갖는다.
    - 이미지레이어의 생애주기 : 내려받은 순간 ~ 삭제 동안에 로컬 컴퓨터의 이미지 레이어에 존재
    - 쓰기가능레이어의 생애주기 : 실행 ~ 삭제

### 🔎 읽기 전용 레이어를 어떻게 수정해?

**기록 중 복사(copy-on-write) 방법을 사용해 읽기전용 레이어의 파일을 수정가능**

- 컨테이너에서 이미지 레이어에 포함된 파일을 수정하려하면, 도커가 해당 파일을 쓰기 가능레이어로 복사해 온 다음 쓰기 가능레이어에서 파일을 수정함
- 컨테이너 파일 시스템은 컨테이너와 같은 생애주기를 갖음
  - 컨테이너가 삭제되면 컨테이너의 기록 가능 레이어와 여기서 수정된 데이터도 함께 삭제된다.
  <div style="height:100px"></div>

## ✏️ 도커 볼륨, 마운트

### 🔎 데이터를 잃으면 어떻게해?

컨테이너의 가상파일시스템은 이미지 레이어와 기록 가능 레이어로 구성된다.

여기에 도커볼륨(Docker volume)과 마운트(mount)를 추가함으로 문제상황을 극복할 수 있다.

이들은 컨테이너와 별개의 생애주기를 갖으므로 컨테이너가 대체돼도 지속돼야하는 데이터를 저장가능하다.

### 🔎 도커 볼륨이 뭐야?

**도커 볼륨(Docker volume)**

- 도커에서 스토리지를 다루는 단위
- 컨테이너와 독립적으로 존재하며 별도의 생애주기를 갖지만 컨테이너에 연결 가능
  - 컨테이너에 연결하면 파일시스템의 한 디렉터리가 됨
  - 컨테이너가 변경되어도 다시 연결하면 데이터는 유지가능
- 퍼시스턴시가 필요한 유상태 애플리케이션을 컨테이너로 실행하기위해 볼륨의 사용이 요구됨
- 이미지에서 정의하는 것 보다는 명시적으로 관리하는 편이 더 낫다.
- 컨테이너간 파일 공유 보다는 업데이트 간 상태 보준 용도로 사용해야한다.
  > 애플리케이션 컨테이너는 자신만이 접근할 수 있는 파일을 필요로 할때가 있고, 다른 컨테이너가 동시에 접근하게 허용하는 경우 애플리케이션이 비정상적으로 동작할 수 있다.

### 🔎 도커 볼륨을 어떻게 사용해?

첫 번째 방법

- 수동으로 직접 볼륨 생성 및 컨테이너에 연결

두 번째 방법

- Dockerfile 스크립트 VOLUME 인스트럭션 사용 `VOLUME <target-directory>`

### 🔎 마운트가 뭐야?

**마운트 (mount)**
볼륨은 호스트 컴퓨터상에 존재하지만 컨테이너와는 분리돼있다.

볼륨과 스토리지 컨테이너를 좀 더 직접적으로 연결하는데 사용되는 것이 바인드 마운트(bind mount)이다.

- 호스트 컴퓨터 파일 시스템의 디렉터리를 컨테이너 파일 시스템의 디렉터리로 만드는 역할
- 컨테이너의 입장에서 바인드마운트는 평범한 디렉터리
- 호스트 컴퓨터의 파일 시스템을 명시적으로 지정해 컨테이너 데이터로 사용가능
- 양방향으로 동작하므로 컨테이너에서 만든 파일을 호스트 컴퓨터에서 수정하거나, 호스트에서 만든 파일을 컨테이너에서 수정하는 것이 가능해진다.
  - 호스트 컴퓨터에대한 공격을 방지하고자 컨테이너는 대개 최소 권한을 가진 계정으로 실행되나, 바인드 마운트의 사용으로 호스트 컴퓨터 파일에 접근하기 위한 권한 상승이 요구된다.
    - dokerfile 스크립트에서 USER인스트럭션을 사용해 컨테이너에 관리자 권한을 부여

### 🔎 마운트의 한계점

- 이미 존재하는 대상 디렉터리에 마운트하면 마운트의 원본 디렉터리가 기존 디렉터리를 완전히 대체하여 기존 파일을 사용할 수 없어짐
- 호스트 컴퓨터의 파일 하나를 컨테이너에 이미 존재하는 디렉터리로 마운트하는경우에는 디렉터리의 파일이 합쳐져 이미지에서 온 파일과 호스트에서 마운트된 파일이 모두 나타남
- 분산파일시스템을 컨테이너에 바인드마운트하면 일반적인 파일 시스템의 일부처럼 보이기는 하겠지만 지원하지않는 동작이 있을수있다.

<div style="height:100px"></div>

## ✏️ 컨테이너의 파일 시스템이 만들어지는 과정

### 🔎 유니언 파일 시스템

**유니언 파일 시스템(Union File System)**<br/>
도커가 다양한 출처로 부터 모아 만든 단일 가상 디스크로 구성된 파일 시스템

- 유니언 파일 시스템은 운영체제마다 다른 방식으로 구현되어져있음
- 컨테이너는 유니언 파일 시스템을 통해 물리적 위치가 서로 다른 파일과 디렉터리에 단일 디스크를 사용하듯 접근 가능

- 컨테이너에서 실행되는 애플리케이션의 입장에서는 단일 디스크만 볼 수 있지만, 컨테이너 및 이미지를 생성하는 사용자는 여러 출처를 합쳐 디스크를 구성할 수 있음

### 🔎 컨테이너 스토리지 구성 일반론

<img width="714" alt="스크린샷 2023-09-17 오후 8 22 16" src="https://github.com/youkyeong60/vanillaJS_SPA/assets/75975946/d558f508-cbf2-4c10-a64a-6f05a603b57d">

- 기록 가능 레이어
  - 비용이 비싼 계산 및 네트워크를 통해 저장해야하는 데이터 캐싱 등 단기 저장에 적합
  - 각 컨테이너마다 독립적인 기록 가능 레이어를 갖으나 컨테이너가 삭제되면 데이터는 유실
- 로컬 바인드 마운트
  - 호스트 컴퓨터와 컨테이너간 데이터 공유를 위해 사용
  - 개발자의로컬 컴퓨터에서 컨테이너로 소스코드를 전달하기 위해 사용시 로컬 컴퓨터에서 수정한 내용이 이미지 빌드 없이도 즉시 컨테이너로 전달 가능
- 분산 마인드 마운트
  - 네트워크 스토리지와 컨테이너 간에 데이터를 공유하기 위해 사용
  - 읽기 전용으로 설정 파일 전달 및 공유 캐시로 활용가능
  - 읽기 쓰기 가능으로 데이터를 저장해 동일 네트워크 상의 모든 컨테이너나 컴퓨터와 데이터 공유에 적합
- 볼륨 마운트
  - 컨테이너와 도커 객체인 볼륨 간에 데이터 공유에 이용
  - 애플리케이션이 볼륨에 영구적으로 데이터를 저장
- 이미지 레이어
  - 컨테이너의 초기 파일 시스템을 구성
  - 레이어가 적층 구조를 가져 후속레이어와 이전 레이어의 내용이 충돌하는 경우 후속 레이어의 내용이 적용
  - 읽기전용 레이어로 여러 컨테이너에서 공유

<div style="height:150px"></div>

### 📖 참고 문헌

도커 교과서 제 1부 도커 컨테이너와 이미지 이해하기 Ch06
