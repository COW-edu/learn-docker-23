# 6장 도커 볼륨을 이용한 퍼시스턴트 스토리지

컨테이너는 무상태 애플리케이션에게는 최적의 실행 환경이다. 사용량이 증가하더라도 클러스터에 실행 중인 컨테이너의 수를 늘리기만 하면 모든 요청이 신뢰성 있게 처리된다.


### 컨테이너 속 데이터가 사라지는 이유

* 기본적으로 컨테이너를 종료해도 파일 시스템은 삭제되지 않는다. 

* 컨테이너 파일 시스템은 서로 독립적이다. 즉 같은 데이터베이스 엔진 이미지로 실행된 두 컨테이너가 서로 전혀 다른 데이터를 담을 수 있는 것이다.

컨테이너의 파일 시스템은 단일 디스크이나, 해당 디스크는 도커가 여러 출처로부터 합쳐 만들고 컨테이너에 전달한 가상 파일 시스템이다.
해당 출처는 이미지 레이어와 컨테이너의 기록 가능 레이어로 구성되는데, 이미지 레이어는 모든 컨테이너가 공유하지만 기록 가능 레이어는 컨테이너마다 다르다.

즉 이미지 레이어는 이미지를 내려받은 순간부터 삭제할 때까지 로컬의 이미지 레이어에 존재하나,
쓰기 가능 레이어는 컨테이너를 실행할 때 생성, 삭제할 때 함께 삭제된다.

이러한 특성 때문에 도커 컨테이너를 삭제하더라도 데이터를 보관할 수 있는 방법이 필요했고,
대표적인 것이 `도커 볼륨`, `도커 마운트` 이다. 이들은 컨테이너와는 별개의 생애 주기를 갖는다.

도커에서는 이미지 레이어에 있는 파일을 수정하는 기능을 지원하는데, 이는 도커에서 `기록 중 복사(copy-on-write)`를 지원하기 때문이다.
컨테이너에서 이미지 레이어에 포함된 파일을 수정하면, 도커가 파일을 쓰기가능 레이어로 복사해 온 다음에 이를 수정한다.

### 도커 볼륨을 사용하는 컨테이너 실행하기
도커 볼륨 : 도커에서 스토리지를 다루는 단위다. 컨테이너를 위한 usb 메모리라고 생각하자.
볼륨을 생성하여 컨테이너에 연결하면 파일 시스템에 한 디렉토리가 된다. 애플리케이션 업데이트를 위해 새로운 컨테이너를 만들더라도, 
다시 볼륨을 연결하면 데이터가 그대로 유지된다.

컨테이너에서 볼륨을 사용하는 방법
1. 수동으로 볼륨 생성, 컨테이너에 연결
2. Dockerfile 스크립트에서 VOLUME 인스트럭션 사용
    * 해당 인스트럭션을 사용해 만든 이미지로 컨테이너를 실행하면 자동으로 볼륨을 생성한다.

도커 이미지에서 볼륨을 정의하면 컨테이너를 생성할 때마다 새 볼륨을 만들지만, 컨테이너가 같은 볼륨을 공유하게 할 수도 있다.

```dockerfile
docker container run --name todo2 -d diamol/ch06-todo-list

docker container exec todo2 cmd /C "dir C:\data"

# 해당 컨테이너는 todo1의 볼륨을 공유한다(--volumes-from)
docker container run -d --name t3 --volumes-from todo1 diamol/ch06-todo-list

docker container exec t3 cmd /C "dir C:\data"
```

Docker 스크립트의 VOLUMN 인스트럭션과 docker container 명령의 --volumn 플래그는 별개 기능이다.
VOLUMN 인스트럭션을 사용해 빌드된 이미지로 docker container run 명령에서 볼륨을 지정하지 않으면 항상 새로운 볼륨을 함께 생성한다.
그러나 --volumn 플래그는 지정된 볼륨을 컨테이너에 무조건 마운트한다.

### 파일 시스템 마운트를 사용하는 컨테이너 실행하기

볼륨의 장점은 컨테이너와 스토리지의 생애주기를 분리하면서도 도커를 사용하는 방식 그대로 스토리지를 다룰 수 있다는 점이다.
호스트의 스토리지를 컨테이너에 좀 더 직접적으로 연결하는 방법으로 `바인드 마운트(bind mount)`가 있다. 바인드 마운트는 호스트 컴퓨터 파일 시트메의 디렉터리를 컨테이너 파일 시스템의 디렉터리로 만든다.
이렇게 되면 컨테이너가 호스트 컴퓨터 파일에 직접 접근할 수 있고, 그 반대도 가능하다.
호스트 컴퓨터의 파일 시스템을 명시적으로 지정해 컨테이너 데이터로 사용할 수 있게 된다. 

### 파일 시스템 마운트의 한계점

이미 존재하는 대상 디렉터리에 망누트하면 마운트의 원본 디렉터리가 기존 디렉터리를 완전히 대체한다.

호스트 컴퓨터의 파일 하나를 컨테이너에 이미 존재하는 디렉터리로 마운트하면 디렉터리의 파일이 합쳐져 나타난다.

분산 파일 시스템의 매커니즘은 로컬 파일 시스템과 다른 경우가 많고, 성능적인 차이도 크므로 주의가 필요하다.

### 컨테이너의 파일 시스템은 어떻게 만들어지는가?
모든 컨테이너는 도커가 다양한 출처로부터 모은 단일 가상 디스크로 구성된 파일 시스템을 갖고, 이를 union file system이라고 한다.

컨테이너 스토리지를 구상할 때 고려야해야 할 것
* 기록 가능 레이어 : 비용이 비싼 계산, 네트워크를 통해 저장해야 하는 데이터 캐싱 등 단기 저장에 적합
  * 컨테이너가 삭제되면 저장된 데이터가 유실된다.
* 로컬 바인드 마운트 : 호스트 컴퓨터-컨테이너 간 데이터 공유를 위해 사용, 로컬의 수정사항이 이미지 빌드 없이 컨테이너로 전달 가능
* 분산 바인드 마운트 : 네트워크 스토리지-컨테이너 간 데이터 공유를 위해 사용, 미지원하는 파일 시스템, 성능 차이를 고려할 것.
* 볼륨 마운트 : 도커 객체인 볼륨 간에 데이터 공유를 위해 사용, 애플리케이션이 볼륨에 데이터를 영구적 저장하므로 컨테이너 교체시 유용
* 이미지 레이어: 컨테이너 초기 파일 시스템 구성. 읽기 전용이며 여러 컨테이너가 공유함.


