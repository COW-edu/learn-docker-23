# 도커 볼륨을 이용한 퍼시스턴트 스토리지
- 컨테이너의 파일 시스템은 컨테이너와 같은 생애주기를 갖기 때문에 컨테이너 삭제 시 컨테이너 파일 시스템의 데이터도 같이 삭제된다.
- 도커 볼륨과 도커 마운트를 통해 컨테이너와 별도의 생애주기를 갖는 데이터를 저장할 수 있다.

## 도커 볼륨
- 도커에서 스토리지를 다루는 단위(컨테이너를 위한 USB)
- 볼륨을 생성해 어플리케이션 컨테이너에 연결 시 파일 해당 컨테이너 파일 시스템의 한 디렉터리가 되어 어플리케이션 컨테이너의 퍼시스턴시를 가능하게 한다.
- 볼륨 사용 방법
    1. 수동으로 직접 볼륨 생성 후 컨테이너에 연결
    2. Dokerfile 스크립트에서 `VOLUME` 인스트럭션 사용 - 인스트럭션 문법: `VOLUME <target-directory>`
        - 해당 인스트럭션을 통해 지정한 디렉토리의 내용은 볼륨에 영구적으로 저장됨
- 도커 이미지에서 볼륨 정의 시 컨테이너 생성마다 새로운 볼륨을 생성
    - `volume-from` 플래그를 적용해 다른 컨테이너에 볼륨 공유 가능 ex. `docker container run -d --name t3 --volumes-from todo1 ...`
- **컨테이너 간 볼륨 공유는 파일 공유보다는 업데이트 간 상태 보존을 위한 용도로 사용해야 하며, 명시적으로 관리하는 것이 좋다.**
- Dokerfile 스크립트의 `VOLUME` 인스트럭션과 docker container 명령의 `--volume` 플래그는 별개 기능
    - `VOlUME` 인스트럭션을 사용한 이미지로 빌드한 컨테이너에 `--volume`을 사용해 볼륨 미지정 시 항상 새로운 볼륨 생성
    - `--volume` 지정 시 이미지에 볼륨 정의 여부와 관계 없이 지정된 볼륨을 컨테이너에 마운트

## 파일 시스템 마운트 컨테이너(바인드 마운트)
- 바인드 마운트: 호스트 컴퓨터 파일 시스템 디렉토리를 컨테이너 파일 시스템의 디렉토리로 만든다.
    - 컨테이너 입장에선 볼륨과 마찬가지로 평범한 스토리지 디렉토리
    - 호스트 컴퓨터에서 접근 가능한 파일 시스템이라면 무엇이든 컨테이너의 파일시스템으로 사용 가능
- 바인드 마운트는 양방향으로 동작한다. 컨테이너에서 만든 파일을 호스트 컴퓨터에서 수정 가능하고, 호스트 컴퓨터에서 만든 파일을 컨테이너에서 수정 가능하다.
    - 이때 컨테이너에서 호스트 컴퓨터 파일에 접근하기 위해 Dockerfile 스크립트에서 `USER` 인스트럭션을 통해 권한 상승 필요

## 바인드 바운트 한계
- 컨테이너에 마운트 대상 디렉토리가 이미 존재하고 이미지 레이어에 이 디렉토리의 파일이 포함되어 있을 경우: 기존 마운트 디렉토리가 이미지 레이어에서 빌드된 파일을 대체 -> 이미지 레이어의 파일 사용X
- 호스트 컴퓨터의 파일을 컨테이너에 이미 존재하는 디렉토리로 마운트 할 경우: 디렉토리의 파일이 합쳐져 이미지 레이어에서 빌드된 파일과 호스트에서 마운트된 파일 모두 나타남.(윈도우 컨테이너는 해당 기능 동작X)
- 분산 파일 시스템을 컨테이너에 마운트 할 경우: 분산 파일 시스템이 지원하지 않는 기능을 애플리케이션에서 사용하지 못하는 문제 발생, 디스크 사용량이 많은 어플리케이션일 경우 네트워크를 거쳐야 하는 만큼 위험성 증가

## 컨테이너의 파일 시스템
- 도커 컨테이너는 **유니언 파일 시스템**이라는 단일 가상 디스크 파일 시스템을 갖는다.
- 도커 컨테이너는 유니언 파일 시스템을 통해 물리적 위치가 다른 파일과 디렉토리에 단일 디스크를 사용하듯 접근 할 수 있다.
- 컨테이너 스토리지 구성 시 고려할 사항
    - 기록 가능 레이어: 코스트가 많이드는 계산, 데이터 캐싱 등의 단기 저장에 적합.<br> 컨테이너마다 독립적이고 컨테이너와 생명주기 동일
    - 로컬 바인드 마운트: 호스트 컴퓨터와 컨테이너 간 데이터 공유를 위해 사용
    - 분산 바인드 마운트: 네트워크 스토리지와 컨테이너 간 데이터 공유 시 사용. <br>읽기 전용 설정 파일 전달, 동일 네트워크 상의 자원들끼리 데이터 공유 시 용이
    - 볼륨 마운트: 볼륨과 컨테이너 간 데이터 공유 시 사용.<br> 어플리케이션이 해당 볼륨에 데이터 영구 저장, 컨테이너 교체 시에도 데이터 유지
    - 이미지 레이어: 컨테이너 초기 파일 시스템 구성.<br> 레이어는 읽기 전용이며 여러 컨테이너가 공유
